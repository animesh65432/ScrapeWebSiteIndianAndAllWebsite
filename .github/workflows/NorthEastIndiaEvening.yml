name: Scraper NorthEast India

on:
  schedule:
    - cron: "30 8 * * *"
    - cron: "30 14 * * *"
  workflow_dispatch:
    inputs:
      run_type:
        description: "Run type (morning/evening/manual)"
        required: false
        default: "manual"

permissions:
  contents: write

jobs:
  scrape:
    runs-on: ubuntu-latest
    timeout-minutes: 50

    env:
      SCARPER_API_TOKEN: ${{ secrets.SCARPER_API_TOKEN}}
      REVERSE_PROXY: ${{ secrets.REVERSE_PROXY }}
      RUN_TYPE: ${{ github.event.inputs.run_type || 'scheduled' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Scrape NorthEast India
        id: scrape
        run: |
          echo "Starting scrape..."
          python3 -m Scrape.NORTHEAST_INDIA
          SCRAPE_EXIT=$?
          echo "scrape_status=$SCRAPE_EXIT" >> $GITHUB_OUTPUT
          exit 0
        continue-on-error: true

      - name: Check scrape results
        id: check_results
        run: |
          # Check if scraper actually produced data
          if [ -d "data/northEastIndia" ] && [ -n "$(find data/northEastIndia -name '*.json' -type f 2>/dev/null)" ]; then
            echo "âœ… JSON files found"
            echo "has_data=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ No JSON files found - scraper may have failed"
            echo "has_data=false" >> $GITHUB_OUTPUT
            
            # Create folder if missing
            mkdir -p data/northEastIndia
            
            # Create placeholder with error info
            cat > data/northEastIndia/scrape_failed_$(date +'%Y%m%d_%H%M%S').json << EOF
          {
            "status": "failed",
            "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "message": "Scraper did not produce output - check logs",
            "run_type": "${{ env.RUN_TYPE }}"
          }
          EOF
          fi

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: northEastIndia-data-${{ github.run_number }}-${{ github.run_attempt }}
          path: data/northEastIndia/*.json
          retention-days: 7
          if-no-files-found: warn

      - name: Commit results
        if: always()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Add all changes
          git add data/northEastIndia/ || true

          # Check if there are changes to commit
          if ! git diff --staged --quiet; then
            COMMIT_MSG="ðŸ“Š Update North East India data - $(date +'%Y-%m-%d %H:%M UTC')"
            
            # Add status indicators
            if [ "${{ steps.check_results.outputs.has_data }}" == "true" ]; then
              COMMIT_MSG="$COMMIT_MSG âœ…"
            else
              COMMIT_MSG="$COMMIT_MSG âš ï¸ (No data)"
            fi
            
            git commit -m "$COMMIT_MSG"
            git push || echo "âš ï¸ Push failed - may need to pull first"
          else
            echo "â„¹ï¸ No changes to commit"
          fi

      - name: Summary
        if: always()
        run: |
          echo "## Scrape Summary ðŸ“Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Run Type:** ${{ env.RUN_TYPE }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "- **Has Data:** ${{ steps.check_results.outputs.has_data }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Scrape Exit Code:** ${{ steps.scrape.outputs.scrape_status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -d "data/northEastIndia" ]; then
            FILE_COUNT=$(find data/northEastIndia -name '*.json' -type f 2>/dev/null | wc -l)
            echo "- **JSON Files Created:** $FILE_COUNT" >> $GITHUB_STEP_SUMMARY
          fi
